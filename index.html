<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Calculs VL / DAB / Prix ‚Äì Espace</title>

<!-- Ic√¥nes -->
<link rel="icon" type="image/png" href="icon.png">
<link rel="apple-touch-icon" href="icon.png">

<style>
  :root{--bg:#0f172a;--card:#111827;--ink:#e5e7eb;--muted:#9ca3af;--accent:#22d3ee;--border:#1f2937;--input:#0b1220;--btn:#0b1220;--btnbd:#1f2937;}
  [data-theme="light"]{--bg:#f8fafc;--card:#ffffff;--ink:#0f172a;--muted:#475569;--accent:#06b6d4;--border:#e2e8f0;--input:#ffffff;--btn:#ffffff;--btnbd:#cbd5e1;}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1080px;margin:0 auto;padding:18px}
  h1{font-size:1.4rem;margin:6px 0 8px}
  .sub{color:var(--muted);font-size:.9rem;margin-bottom:16px}
  .nav{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0 16px}
  .nav .right{margin-left:auto}
  .grid{display:grid;gap:14px}
  @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
  .card h2{font-size:1.05rem;margin:0 0 10px;color:var(--accent)}
  label{display:block;font-size:.9rem;margin:10px 0 4px;color:var(--muted)}
  input{width:100%;padding:10px;border:1px solid var(--border);border-radius:12px;background:var(--input);color:var(--ink)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .hint{font-size:.8rem;color:var(--muted)}
  .out{font-variant-numeric:tabular-nums}
  .home-grid{display:grid;gap:14px;grid-template-columns:1fr}
  @media(min-width:860px){.home-grid{grid-template-columns:1fr 1fr 1fr}}
  .home-card{cursor:pointer;text-align:center;padding:24px}
  .home-card h3{margin:0 0 8px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
  .btn{padding:9px 12px;border-radius:12px;border:1px solid var(--btnbd);background:var(--btn);color:var(--ink);cursor:pointer}
  footer{margin-top:18px;color:var(--muted);font-size:.8rem}
  hr{border:0;border-top:1px solid var(--border);margin:14px 0}

  /* Impression : ne sortir que la carte marqu√©e .to-print */
  @media print{
    body{ background:#ffffff !important; color:#000 !important; }
    .nav, .home-grid, footer, .toolbar{ display:none !important; }
    .card{ box-shadow:none !important; border:0 !important; }
    .card:not(.to-print){ display:none !important; }
  }
</style>

<!-- Librairies PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
<div class="wrap">
  <div class="nav">
    <h1 style="margin:0">Espace calculs ‚Äì VL / DAB / Prix</h1>
    <span class="sub">Choisis un module ou reste sur l'accueil</span>
    <button id="toggleTheme" class="btn right">üåì Th√®me</button>
  </div>

  <!-- Accueil -->
  <section id="home">
    <div class="home-grid">
      <div class="card home-card" onclick="show('vl')">
        <h3>üè∑Ô∏è Valeur locative</h3>
        <div class="hint">Formule mixte : (loyer + prix√ótaux)/surface</div>
      </div>
      <div class="card home-card" onclick="show('dab')">
        <h3>üìú Droit au bail</h3>
        <div class="hint">√âconomies actualis√©es sur dur√©e certaine</div>
      </div>
      <div class="card home-card" onclick="show('prix')">
        <h3>üí∂ Prix √† partir du loyer</h3>
        <div class="hint">Prix = Loyer annuel / Rendement</div>
      </div>
    </div>
  </section>

  <!-- VL -->
  <section id="vl" style="display:none">
    <div class="card" id="vlCard">
      <h2>Valeur locative (formule mixte)</h2>
      <div class="row">
        <div><label>Loyer constat√© (‚Ç¨/an)</label><input type="number" id="loyerConst" value="18000" step="0.01"></div>
        <div><label>Prix de cession (‚Ç¨)</label><input type="number" id="prixCession" value="300000" step="0.01"></div>
      </div>
      <div class="row">
        <div><label>Taux de rendement esp√©r√© (%)</label><input type="number" id="tauxRdt" value="6" step="0.01"></div>
        <div><label>Surface de r√©f√©rence (m¬≤)</label><input type="number" id="surface" value="100" step="0.01"></div>
      </div>
      <hr>
      <div class="out" id="outVL"></div>
      <div class="toolbar">
        <button class="btn" onclick="exportPDF('vlCard','vl_calcul.pdf')">üìÑ Exporter en PDF</button>
        <button class="btn" onclick="printCard('vlCard')">üñ®Ô∏è Imprimer en PDF</button>
        <button class="btn" onclick="show('home')">‚¨ÖÔ∏è Accueil</button>
      </div>
    </div>
  </section>

  <!-- DAB -->
  <section id="dab" style="display:none">
    <div class="card" id="dabCard">
      <h2>Droit au bail (√©conomies actualis√©es)</h2>
      <div class="row">
        <div><label>Valeur locative de march√© (‚Ç¨/an)</label><input type="number" id="vlMarche" value="36000" step="0.01"></div>
        <div><label>Loyer pay√© au bail (‚Ç¨/an)</label><input type="number" id="loyerBail" value="24000" step="0.01"></div>
      </div>
      <div class="row">
        <div><label>Taux d‚Äôactualisation (%)</label><input type="number" id="tauxActu" value="6" step="0.01"></div>
        <div><label>Dur√©e certaine (ann√©es)</label><input type="number" id="duree" value="6" step="0.25"></div>
      </div>
      <hr>
      <div class="out" id="outDAB"></div>
      <div class="hint" id="noteDAB"></div>
      <div class="toolbar">
        <button class="btn" onclick="exportPDF('dabCard','dab_calcul.pdf')">üìÑ Exporter en PDF</button>
        <button class="btn" onclick="printCard('dabCard')">üñ®Ô∏è Imprimer en PDF</button>
        <button class="btn" onclick="show('home')">‚¨ÖÔ∏è Accueil</button>
      </div>
    </div>
  </section>

  <!-- Prix -->
  <section id="prix" style="display:none">
    <div class="card" id="prixCard">
      <h2>Prix de vente cible (√† partir du loyer annuel)</h2>
      <div class="row">
        <div><label>Loyer annuel (‚Ç¨/an)</label><input type="number" id="loyerAnnuelPrix" value="36000" step="0.01"></div>
        <div><label>Rendement esp√©r√© (%)</label><input type="number" id="rdtPrix" value="6" step="0.1"></div>
      </div>
      <div style="margin-top:10px">
        <label>Varier le rendement (%)</label>
        <input type="range" id="rdtSlider" min="3" max="12" step="0.1" value="6" oninput="syncRdt(this.value)">
      </div>
      <hr>
      <div class="out" id="outPrix"></div>
      <div id="tablePrix"></div>
      <div class="toolbar">
        <button class="btn" onclick="exportPDF('prixCard','prix_calcul.pdf')">üìÑ Exporter en PDF</button>
        <button class="btn" onclick="printCard('prixCard')">üñ®Ô∏è Imprimer en PDF</button>
        <button class="btn" onclick="show('home')">‚¨ÖÔ∏è Accueil</button>
      </div>
    </div>
  </section>

  <footer>‚ö†Ô∏è R√©sultats indicatifs. Confronter au bail, au march√© et √† la r√©glementation.</footer>
</div>

<script>
const $ = id => document.getElementById(id);

// th√®me
(function(){
  const t = localStorage.getItem('theme');
  if (t) document.documentElement.setAttribute('data-theme', t);
  $('toggleTheme').onclick = ()=>{
    const cur = document.documentElement.getAttribute('data-theme')==='light'?'dark':'light';
    document.documentElement.setAttribute('data-theme',cur);
    localStorage.setItem('theme',cur);
  };
})();

// navigation
function show(sec){ ['home','vl','dab','prix'].forEach(id=>$(id).style.display='none'); $(sec).style.display='block'; window.scrollTo({top:0,behavior:'smooth'}); }

// utils
function n(v){ return isFinite(v)?v:0; }
function fmtEUR(x){ return (isFinite(x)?x:0).toLocaleString('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:0}); }
function fmtNb(x){ return (isFinite(x)?x:0).toLocaleString('fr-FR',{maximumFractionDigits:2}); }

// VL
function calcVL(){
  const l = parseFloat($('loyerConst').value), p = parseFloat($('prixCession').value), t = parseFloat($('tauxRdt').value)/100, s = parseFloat($('surface').value);
  const vl_m2 = s>0 ? (n(l)+n(p)*n(t))/s : 0, ann = vl_m2*s, mens = ann/12;
  $('outVL').innerHTML = `<div><div><strong>VL ‚âà ${fmtNb(vl_m2)} ‚Ç¨/m¬≤/an</strong></div><div>Loyer cible annuel ‚âà ${fmtEUR(ann)}</div><div>Loyer cible mensuel ‚âà ${fmtEUR(mens)}</div></div>`;
}
['loyerConst','prixCession','tauxRdt','surface'].forEach(id=>document.addEventListener('input',e=>{ if(e.target.id===id) calcVL(); }));

// DAB
function calcDAB(){
  const vl = parseFloat($('vlMarche').value), lb = parseFloat($('loyerBail').value), r = parseFloat($('tauxActu').value)/100, nAn = parseFloat($('duree').value);
  const eco = n(vl)-n(lb); let dab=0, msg='';
  if(r<=0||nAn<=0){ msg='Taux et dur√©e doivent √™tre > 0.'; }
  else{ const fac = 1 - 1/Math.pow(1+r,nAn); dab = (eco/r)*fac; if(eco<=0) msg='‚ö†Ô∏è √âconomie ‚â§ 0 : DAB nul ou n√©gatif.'; }
  $('outDAB').innerHTML = `<div><div>√âconomie annuelle : ${fmtEUR(eco)}</div><div><strong>Droit au bail ‚âà ${fmtEUR(dab)}</strong></div></div>`;
  $('noteDAB').textContent = msg;
}
['vlMarche','loyerBail','tauxActu','duree'].forEach(id=>document.addEventListener('input',e=>{ if(e.target.id===id) calcDAB(); }));

// Prix
function syncRdt(v){ $('rdtPrix').value=v; calcPrix(); }
['loyerAnnuelPrix','rdtPrix'].forEach(id=>document.addEventListener('input',e=>{ if(e.target.id===id){ if(id==='rdtPrix') $('rdtSlider').value=e.target.value; calcPrix(); }}));
function calcPrix(){
  const L = parseFloat($('loyerAnnuelPrix').value), r = parseFloat($('rdtPrix').value)/100;
  const prix = r>0 ? n(L)/r : 0;
  $('outPrix').innerHTML = `Rendement : ${fmtNb(parseFloat($('rdtPrix').value))}%<br><strong>Prix cible ‚âà ${fmtEUR(prix)}</strong>`;
  // tableau
  let html = '<table style="width:100%;border-collapse:collapse;margin-top:10px;font-size:.9rem"><thead><tr><th style="text-align:left;border-bottom:1px solid var(--border);padding:6px">Rendement</th><th style="text-align:right;border-bottom:1px solid var(--border);padding:6px">Prix estim√©</th></tr></thead><tbody>';
  for(let rr=3; rr<=12.01; rr+=0.5){ const pv = n(L)/(rr/100); html += `<tr><td style="padding:6px">${rr.toFixed(1)} %</td><td style="padding:6px;text-align:right">${fmtEUR(pv)}</td></tr>`; }
  html += '</tbody></table>'; $('tablePrix').innerHTML = html;
}

// Export PDF (portrait A4) + fallbacks Chrome/iOS
async function exportPDF(cardId, filename){
  const node = document.getElementById(cardId);
  // assure fond blanc / calc bien visible
  node.style.background = '#ffffff';
  // capture
  const canvas = await html2canvas(node, {scale:2, background:'#ffffff', useCORS:true, scrollY: -window.scrollY});
  const imgData = canvas.toDataURL('image/jpeg', 0.95);
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'p', unit:'pt', format:'a4'});
  const pageW = doc.internal.pageSize.getWidth(), pageH = doc.internal.pageSize.getHeight();
  const margin = 36, availW = pageW - margin*2, availH = pageH - margin*2;
  const imgW = canvas.width, imgH = canvas.height;
  const ratio = Math.min(availW/imgW, availH/imgH);
  const drawW = imgW*ratio, drawH = imgH*ratio;
  const x = margin + (availW - drawW)/2, y = margin + (availH - drawH)/2;

  // En-t√™te
  try{
    const titre = node.querySelector('h2')?.innerText || 'Calcul';
    doc.setFont('helvetica','normal'); doc.setFontSize(10);
    doc.text(`${titre} ‚Äî ${new Date().toLocaleString('fr-FR')}`, margin, 24);
  }catch(_){}

  doc.addImage(imgData, 'JPEG', x, y, drawW, drawH);

  const name = filename || 'calcul.pdf';
  try{
    // t√©l√©chargement direct (Chrome desktop/mobile si autoris√©)
    doc.save(name);
  }catch(e){
    // fallback : ouvrir un blob (iOS/Chrome si download bloqu√©)
    const blob = doc.output('blob');
    const url  = URL.createObjectURL(blob);
    try{ window.open(url, '_blank'); } catch(e2){ location.href = url; }
    setTimeout(()=>URL.revokeObjectURL(url), 60000);
  }
}

// Impression PDF syst√®me (affiche uniquement la carte)
function printCard(cardId){
  const node = document.getElementById(cardId);
  // marque la carte √† imprimer
  node.classList.add('to-print');
  // d√©clenche l‚Äôimpression
  window.print();
  // nettoyage apr√®s impression
  const cleanup = ()=> node.classList.remove('to-print');
  if ('onafterprint' in window){ window.onafterprint = cleanup; } else { setTimeout(cleanup, 1000); }
}

// init d√©faut
calcVL(); calcDAB(); calcPrix(); show('home');
</script>
</body>
</html>

