<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Calculs VL / DAB / Prix / CF / TRI ‚Äì v5.1</title>

<link rel="icon" type="image/png" href="icon.png">
<link rel="apple-touch-icon" href="icon.png">

<style>
  :root{--bg:#0f172a;--card:#111827;--ink:#e5e7eb;--muted:#9ca3af;--accent:#22d3ee;--border:#1f2937;--input:#0b1220;--btn:#0b1220;--btnbd:#1f2937;}
  [data-theme="light"]{--bg:#f8fafc;--card:#ffffff;--ink:#0f172a;--muted:#475569;--accent:#06b6d4;--border:#e2e8f0;--input:#ffffff;--btn:#ffffff;--btnbd:#cbd5e1;}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1080px;margin:0 auto;padding:18px}
  h1{font-size:1.4rem;margin:6px 0 8px}
  .sub{color:var(--muted);font-size:.9rem;margin-bottom:16px}
  .nav{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0 16px}
  .nav .right{margin-left:auto}
  .grid{display:grid;gap:14px}
  @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
  .card h2{font-size:1.05rem;margin:0 0 10px;color:var(--accent)}
  label{display:block;font-size:.9rem;margin:10px 0 4px;color:var(--muted)}
  input{width:100%;padding:10px;border:1px solid var(--border);border-radius:12px;background:var(--input);color:var(--ink)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .hint{font-size:.8rem;color:var(--muted)}
  .warn{color:#e11d48}
  .out{font-variant-numeric:tabular-nums}
  .home-grid{display:grid;gap:14px;grid-template-columns:1fr}
  @media(min-width:860px){.home-grid{grid-template-columns:1fr 1fr 1fr 1fr 1fr}}
  .home-card{cursor:pointer;text-align:center;padding:24px}
  .home-card h3{margin:0 0 8px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
  .btn{padding:9px 12px;border-radius:12px;border:1px solid var(--btnbd);background:var(--btn);color:var(--ink);cursor:pointer}
  footer{margin-top:18px;color:var(--muted);font-size:.8rem}
  hr{border:0;border-top:1px solid var(--border);margin:14px 0}
  @media print{
    body{background:#fff !important;color:#000 !important;}
    .nav, .home-grid, footer, .toolbar{display:none !important;}
    .card{box-shadow:none !important;border:0 !important;}
    .card:not(.to-print){display:none !important;}
  }
</style>

<!-- Librairies export PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
<div class="wrap">
  <div class="nav">
    <h1 style="margin:0">Espace calculs</h1>
    <span class="sub">VL / DAB / Prix / Cash-flow / TRI</span>
    <button id="toggleTheme" class="btn right">üåì Th√®me</button>
  </div>

  <!-- Accueil -->
  <section id="home">
    <div class="home-grid">
      <div class="card home-card" onclick="show('vl')"><h3>üè∑Ô∏è Valeur locative</h3><div class="hint">Surface simple ou pond√©r√©e</div></div>
      <div class="card home-card" onclick="show('dab')"><h3>üìú Droit au bail</h3></div>
      <div class="card home-card" onclick="show('prix')"><h3>üí∂ Prix cible</h3></div>
      <div class="card home-card" onclick="show('cf')"><h3>üìä Cash-flow (RN/CAF/ŒîBFR)</h3></div>
      <div class="card home-card" onclick="show('tri')"><h3>üìà TRI</h3></div>
    </div>
  </section>

  <!-- VL -->
  <section id="vl" style="display:none">
    <div class="card" id="vlCard">
      <h2>Valeur locative</h2>
      <div class="row">
        <div><label>Loyer constat√© (‚Ç¨/an)</label><input type="number" id="loyerConst" value="18000" step="0.01"></div>
        <div><label>Prix de cession (‚Ç¨)</label><input type="number" id="prixCession" value="300000" step="0.01"></div>
      </div>
      <div class="row">
        <div><label>Taux de rendement esp√©r√© (%)</label><input type="number" id="tauxRdt" value="6" step="0.01"></div>
        <div><label><input type="checkbox" id="usePonderee" onchange="toggleSurface()"> Utiliser surface pond√©r√©e</label></div>
      </div>
      <div id="surfaceSimple">
        <label>Surface totale (m¬≤)</label>
        <input type="number" id="surface" value="100" step="0.01">
      </div>
      <div id="surfacePonderee" style="display:none">
        <div class="row">
          <div><label>Vente (100%)</label><input type="number" id="surfVente" value="80" step="0.01"></div>
          <div><label>R√©serve (50%)</label><input type="number" id="surfReserve" value="20" step="0.01"></div>
        </div>
        <label>Annexes (33%)</label>
        <input type="number" id="surfAnnexes" value="10" step="0.01">
        <div class="hint" id="outSurfPonderee"></div>
      </div>
      <hr>
      <div class="out" id="outVL"></div>
      <div class="hint" id="outVLsurf"></div>
      <div class="toolbar">
        <button class="btn" onclick="exportPDF('vlCard','vl.pdf')">üìÑ Export PDF</button>
        <button class="btn" onclick="printCard('vlCard')">üñ®Ô∏è Imprimer</button>
        <button class="btn" onclick="show('home')">‚¨ÖÔ∏è Accueil</button>
      </div>
    </div>
  </section>

  <!-- DAB -->
  <section id="dab" style="display:none">
    <div class="card" id="dabCard">
      <h2>Droit au bail</h2>
      <div class="row">
        <div><label>VL march√© (‚Ç¨/an)</label><input type="number" id="vlMarche" value="36000" step="0.01"></div>
        <div><label>Loyer bail (‚Ç¨/an)</label><input type="number" id="loyerBail" value="24000" step="0.01"></div>
      </div>
      <div class="row">
        <div><label>Taux actualisation (%)</label><input type="number" id="tauxActu" value="6" step="0.01"></div>
        <div><label>Dur√©e (ann√©es)</label><input type="number" id="duree" value="6" step="0.25"></div>
      </div>
      <hr>
      <div class="out" id="outDAB"></div>
      <div class="hint" id="noteDAB"></div>
      <div class="toolbar">
        <button class="btn" onclick="exportPDF('dabCard','dab.pdf')">üìÑ Export PDF</button>
        <button class="btn" onclick="printCard('dabCard')">üñ®Ô∏è Imprimer</button>
        <button class="btn" onclick="show('home')">‚¨ÖÔ∏è Accueil</button>
      </div>
    </div>
  </section>

  <!-- Prix -->
  <section id="prix" style="display:none">
    <div class="card" id="prixCard">
      <h2>Prix cible</h2>
      <div class="row">
        <div><label>Loyer annuel (‚Ç¨/an)</label><input type="number" id="loyerAnnuelPrix" value="36000" step="0.01"></div>
        <div><label>Rendement (%)</label><input type="number" id="rdtPrix" value="6" step="0.1"></div>
      </div>
      <div style="margin-top:10px">
        <label>Varier le rendement (%)</label>
        <input type="range" id="rdtSlider" min="3" max="12" step="0.1" value="6" oninput="syncRdt(this.value)">
      </div>
      <hr>
      <div class="out" id="outPrix"></div>
      <div id="tablePrix"></div>
      <div class="toolbar">
        <button class="btn" onclick="exportPDF('prixCard','prix.pdf')">üìÑ Export PDF</button>
        <button class="btn" onclick="printCard('prixCard')">üñ®Ô∏è Imprimer</button>
        <button class="btn" onclick="show('home')">‚¨ÖÔ∏è Accueil</button>
      </div>
    </div>
  </section>

 <!-- Cash-flow (RN/CAF/ŒîBFR ou EBE) -->
<section id="cf" style="display:none">
  <div class="card" id="cfCard">
    <h2>Cash-flow (RN/CAF/ŒîBFR ou EBE)</h2>

    <!-- S√©lecteur de m√©thode -->
    <div class="row">
      <div><label><input type="radio" name="cfMode" id="modeRN" checked> M√©thode RN/CAF/ŒîBFR</label></div>
      <div><label><input type="radio" name="cfMode" id="modeEBE"> M√©thode EBE (EBE apr√®s loyers)</label></div>
    </div>

    <!-- Bloc RN/CAF/ŒîBFR -->
    <div id="blocRN">
      <div class="hint">Convention : ŒîBFR saisi <strong>positif si le BFR augmente</strong> (consomme de la tr√©sorerie).</div>
      <div class="row">
        <div><label>R√©sultat net (‚Ç¨/an)</label><input type="number" id="rn" value="70000" step="0.01"></div>
        <div><label>Dot. amort. (‚Ç¨/an)</label><input type="number" id="dotAm" value="20000" step="0.01"></div>
      </div>
      <div class="row">
        <div><label>Dot. provisions (‚Ç¨/an)</label><input type="number" id="dotProv" value="0" step="0.01"></div>
        <div><label>R√©sultats exceptionnels (‚Ç¨/an)</label><input type="number" id="resEx" value="0" step="0.01"></div>
      </div>
      <div class="row">
        <div><label>ŒîBFR (‚Ç¨/an)</label><input type="number" id="deltaBFR" value="0" step="0.01"></div>
        <div></div>
      </div>
    </div>

    <!-- Bloc EBE -->
    <div id="blocEBE" style="display:none">
      <div class="hint">‚ö†Ô∏è EBE saisi **apr√®s loyers** (ne pas re-d√©duire les loyers). ŒîBFR positif = consommation.</div>
      <div class="row">
        <div><label>EBE (‚Ç¨/an)</label><input type="number" id="ebeInput" value="100000" step="0.01"></div>
        <div><label>ŒîBFR (‚Ç¨/an)</label><input type="number" id="deltaBFR_EBE" value="0" step="0.01"></div>
      </div>
    </div>

    <!-- R√©mun√©ration TNS optionnelle (si non incluse dans RN/EBE) -->
    <div class="row">
      <div><label><input type="checkbox" id="useTNS" onchange="toggleTNS()"> Inclure r√©mun√©ration TNS (si <u>non</u> incluse dans le RN/EBE)</label></div>
      <div></div>
    </div>
    <div id="blocTNS" style="display:none">
      <div class="row">
        <div><label>R√©mun√©ration nette (‚Ç¨/mois)</label><input type="number" id="remNet" value="2000" step="0.01"></div>
        <div><label>Charges TNS (%)</label><input type="number" id="tauxTNS" value="45" step="0.01"></div>
      </div>
    </div>

    <hr>
    <h3 style="margin-top:0">Dette</h3>
    <div class="row">
      <div><label>Capital emprunt√© (‚Ç¨)</label><input type="number" id="capEmprunt" value="300000" step="0.01"></div>
      <div><label>Taux (%)</label><input type="number" id="tauxEmprunt" value="4" step="0.01"></div>
    </div>
    <div class="row">
      <div><label>Dur√©e (ans)</label><input type="number" id="dureeEmprunt" value="7" step="0.01"></div>
      <div><span class="hint">L‚Äôannuit√© sert √† obtenir le CF <em>apr√®s</em> dette.</span></div>
    </div>

    <hr>
    <div class="out" id="outCF"></div>
    <div class="toolbar">
      <button class="btn" onclick="exportPDF('cfCard','cf.pdf')">üìÑ Export PDF</button>
      <button class="btn" onclick="printCard('cfCard')">üñ®Ô∏è Imprimer</button>
      <button class="btn" onclick="show('home')">‚¨ÖÔ∏è Accueil</button>
    </div>
  </div>
</section>

  <!-- TRI -->
  <section id="tri" style="display:none">
    <div class="card" id="triCard">
      <h2>TRI simplifi√©</h2>
      <div class="row">
        <div><label>Investissement initial (‚Ç¨)</label><input type="number" id="invInit" value="300000" step="0.01"></div>
        <div><label>CF annuel (hors r√©mun. TNS) (‚Ç¨/an)</label><input type="number" id="cfAn" value="40000" step="0.01"></div>
      </div>
      <div class="row">
        <div><label>Dur√©e (ann√©es)</label><input type="number" id="dureeTRI" value="7" step="0.01"></div>
        <div><label>Valeur de revente (‚Ç¨)</label><input type="number" id="valRevente" value="320000" step="0.01"></div>
      </div>
      <div style="margin-top:6px">
        <label><input type="checkbox" id="incTNS"> Inclure la r√©mun√©ration TNS (net/mois, prise depuis le module CF) dans les flux</label>
      </div>
      <hr>
      <div class="out" id="outTRI"></div>
      <div class="toolbar">
        <button class="btn" onclick="exportPDF('triCard','tri.pdf')">üìÑ Export PDF</button>
        <button class="btn" onclick="printCard('triCard')">üñ®Ô∏è Imprimer</button>
        <button class="btn" onclick="show('home')">‚¨ÖÔ∏è Accueil</button>
      </div>
    </div>
  </section>

  <footer>‚ö†Ô∏è R√©sultats indicatifs. V√©rifier la coh√©rence des p√©rim√®tres (RN, TNS, ŒîBFR) avec les √©tats financiers.</footer>
</div>

<script>
const $=id=>document.getElementById(id);
function show(sec){['home','vl','dab','prix','cf','tri'].forEach(id=>$(id).style.display='none');$(sec).style.display='block';window.scrollTo({top:0,behavior:'smooth'});}

// Th√®me
(function(){
  const t = localStorage.getItem('theme');
  if (t) document.documentElement.setAttribute('data-theme', t);
  $('toggleTheme').onclick = ()=>{
    const cur = document.documentElement.getAttribute('data-theme')==='light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', cur);
    localStorage.setItem('theme', cur);
  };
})();

// Utils
function n(v){ return isFinite(v)?v:0; }
function fmtEUR(x){ return (isFinite(x)?x:0).toLocaleString('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:0}); }
function fmtNb(x){ return (isFinite(x)?x:0).toLocaleString('fr-FR',{maximumFractionDigits:2}); }

// ---------- VL ----------
function toggleSurface(){
  const on = $('usePonderee').checked;
  $('surfaceSimple').style.display = on ? 'none' : 'block';
  $('surfacePonderee').style.display = on ? 'block' : 'none';
  calcVL();
}
function calcVL(){
  const l=+$('loyerConst').value, p=+$('prixCession').value, t=(+$('tauxRdt').value)/100;
  let surf, note;
  if($('usePonderee').checked){
    surf = +$('surfVente').value + (+$('surfReserve').value*0.5) + (+$('surfAnnexes').value*0.33);
    $('outSurfPonderee').innerText = `Surface pond√©r√©e = ${fmtNb(surf)} m¬≤ (vente 100% + r√©serve 50% + annexes 33%)`;
    note = `Surface utilis√©e = ${fmtNb(surf)} m¬≤ (pond√©r√©e)`;
  } else {
    surf = +$('surface').value;
    $('outSurfPonderee').innerText = '';
    note = `Surface utilis√©e = ${fmtNb(surf)} m¬≤ (simple)`;
  }
  const vl_m2 = surf>0 ? (n(l)+n(p)*n(t))/surf : 0;
  const ann = vl_m2*surf, mens = ann/12;
  $('outVL').innerHTML = `<strong>VL ‚âà ${fmtNb(vl_m2)} ‚Ç¨/m¬≤/an</strong><br>Loyer annuel ‚âà ${fmtEUR(ann)} ‚Äî Loyer mensuel ‚âà ${fmtEUR(mens)}`;
  $('outVLsurf').innerText = note;
}
['loyerConst','prixCession','tauxRdt','surface','surfVente','surfReserve','surfAnnexes'].forEach(id=>{
  document.addEventListener('input',e=>{ if(e.target.id===id) calcVL(); });
});

// ---------- DAB ----------
function calcDAB(){
  const vl=+$('vlMarche').value, lb=+$('loyerBail').value, r=(+$('tauxActu').value)/100, nAn=+$('duree').value;
  const eco = n(vl)-n(lb);
  let dab=0, msg='';
  if (r>0 && nAn>0){
    dab = (eco/r) * (1 - 1/Math.pow(1+r, nAn));
    if (eco<=0) msg = "‚ö†Ô∏è √âconomie ‚â§ 0 : DAB nul ou n√©gatif.";
  } else msg = "Taux et dur√©e doivent √™tre > 0.";
  $('outDAB').innerHTML = `√âconomie annuelle : ${fmtEUR(eco)}<br><strong>DAB ‚âà ${fmtEUR(dab)}</strong>`;
  $('noteDAB').textContent = msg;
}
['vlMarche','loyerBail','tauxActu','duree'].forEach(id=>{
  document.addEventListener('input',e=>{ if(e.target.id===id) calcDAB(); });
});

// ---------- Prix ----------
function syncRdt(v){ $('rdtPrix').value=v; calcPrix(); }
['loyerAnnuelPrix','rdtPrix'].forEach(id=>{
  document.addEventListener('input',e=>{ if(e.target.id===id){ if(id==='rdtPrix') $('rdtSlider').value=e.target.value; calcPrix(); }});
});
function calcPrix(){
  const L=+$('loyerAnnuelPrix').value, r=(+$('rdtPrix').value)/100;
  const prix = r>0 ? n(L)/r : 0;
  $('outPrix').innerHTML = `Rendement : ${fmtNb(r*100)}%<br><strong>Prix ‚âà ${fmtEUR(prix)}</strong>`;
  // tableau sensibilit√©
  let html = '<table style="width:100%;border-collapse:collapse;margin-top:10px;font-size:.9rem"><thead><tr><th style="text-align:left;border-bottom:1px solid var(--border);padding:6px">Rendement</th><th style="text-align:right;border-bottom:1px solid var(--border);padding:6px">Prix estim√©</th></tr></thead><tbody>';
  for(let rr=3; rr<=12.01; rr+=0.5){
    const pv = n(L)/(rr/100);
    html += `<tr><td style="padding:6px">${rr.toFixed(1)} %</td><td style="padding:6px;text-align:right">${fmtEUR(pv)}</td></tr>`;
  }
  html += '</tbody></table>';
  $('tablePrix').innerHTML = html;
}

// ---------- Cash-flow (RN/CAF/ŒîBFR) ----------
function toggleTNS(){ $('blocTNS').style.display = $('useTNS').checked ? 'block' : 'none'; calcCF(); }
function mensualite(C, tauxAnnuelPct, dureeAns){
  const nmois = Math.max(1, Math.round(dureeAns*12));
  const i = Math.max(0, tauxAnnuelPct)/100/12;
  if (i===0) return C / nmois;
  return (C*i) / (1 - Math.pow(1+i, -nmois));
}
function calcCF(){
  // CAF
  const rn=+$('rn').value, dotA=+$('dotAm').value, dotP=+$('dotProv').value, rex=+$('resEx').value, dBFR=+$('deltaBFR').value;
  const CAF = rn + dotA + dotP - rex;
  // CF op√©rationnel (ŒîBFR positif = consommation ‚Üí on soustrait)
  const CFop = CAF - dBFR;

  // Dette
  const C=+$('capEmprunt').value, tauxA=+$('tauxEmprunt').value, dureeA=+$('dureeEmprunt').value;
  const M = mensualite(C, tauxA, dureeA);
  const annuite = M*12;

  // CF apr√®s dette (avant r√©mun√©ration)
  let cfApresDette = CFop - annuite;

  // R√©mun√©ration TNS optionnelle si non incluse dans le RN
  let blocTNS = '';
  if ($('useTNS').checked){
    const netMens = +$('remNet').value || 0;
    const tnsPct  = +$('tauxTNS').value || 0;
    const coutAn  = netMens*12*(1+tnsPct/100);
    cfApresDette -= coutAn;
    blocTNS = `<div>R√©mun√©ration TNS non incluse dans le RN : ${fmtEUR(netMens*12)} net/an ‚Äî Co√ªt entreprise ‚âà ${fmtEUR(coutAn)}</div>`;
  }

  $('outCF').innerHTML =
    `<div>CAF = RN + Dot. amort. + Dot. prov. ‚àí R√©s. except. = <strong>${fmtEUR(CAF)}</strong></div>
     <div>CF op√©rationnel = CAF ‚àí ŒîBFR = <strong>${fmtEUR(CFop)}</strong> (ŒîBFR saisi positif si hausse du besoin)</div>
     <div>Annuit√© de dette ‚âà ${fmtEUR(M)} / mois (${fmtEUR(annuite)} / an)</div>
     ${blocTNS}
     <hr style="border:0;border-top:1px solid var(--border)">
     <div><strong>CF apr√®s dette${$('useTNS').checked?' & r√©mun.':''} :</strong> ${fmtEUR(cfApresDette)} / an (${fmtEUR(cfApresDette/12)} / mois)</div>`;
}
['rn','dotAm','dotProv','resEx','deltaBFR','capEmprunt','tauxEmprunt','dureeEmprunt','remNet','tauxTNS'].forEach(id=>{
  document.addEventListener('input',e=>{ if(e.target.id===id) calcCF(); });
});

// ---------- TRI simplifi√© ----------
function npv(rate, flows){ let v=0; for(let t=0;t<flows.length;t++) v += flows[t] / Math.pow(1+rate, t); return v; }
function irr(flows){
  let low=-0.99, high=1.0, fLow=npv(low,flows), fHigh=npv(high,flows), tries=0;
  while(fLow*fHigh>0 && tries<10){ high*=2; fHigh=npv(high,flows); tries++; if(high>10)break; }
  if (fLow*fHigh>0) return null;
  for(let i=0;i<80;i++){ const mid=(low+high)/2, fMid=npv(mid,flows);
    if (Math.abs(fMid)<1e-6) return mid;
    if (fLow*fMid<0){ high=mid; fHigh=fMid; } else { low=mid; fLow=fMid; }
  }
  return (low+high)/2;
}
function calcTRI(){
  const I = +$('invInit').value;
  const cfBase = +$('cfAn').value;
  const nY = Math.max(1, Math.round(+$('dureeTRI').value));
  const VR = +$('valRevente').value;

  // S√©rie hors r√©mun√©ration
  const flows1 = [-I];
  for(let t=1;t<=nY;t++) flows1.push(cfBase + (t===nY?VR:0));
  const r1 = irr(flows1);

  // Inclure r√©mun√©ration TNS (net) comme flux positif additionnel
  let r2 = null, addTxt = '';
  if ($('incTNS').checked){
    const netMens = +$('remNet').value || 0;
    const add = netMens*12;
    const flows2 = [-I];
    for(let t=1;t<=nY;t++) flows2.push(cfBase + add + (t===nY?VR:0));
    r2 = irr(flows2);
    addTxt = `<div>+ R√©mun√©ration TNS ajout√©e aux flux : ${fmtEUR(add)} / an</div>`;
  }

  let html = `<div>Investissement initial : ${fmtEUR(I)} ‚Äî CF annuel (base) : ${fmtEUR(cfBase)} ‚Äî Dur√©e : ${nY} ans ‚Äî Revente : ${fmtEUR(VR)}</div>${addTxt}<hr style="border:0;border-top:1px solid var(--border)">`;
  html += `<div><strong>TRI hors r√©mun√©ration TNS :</strong> ${r1!==null ? fmtNb(r1*100)+' %' : '‚Äî (non calculable)'} </div>`;
  if ($('incTNS').checked) html += `<div><strong>TRI avec r√©mun√©ration TNS :</strong> ${r2!==null ? fmtNb(r2*100)+' %' : '‚Äî (non calculable)'} </div>`;
  $('outTRI').innerHTML = html;
}
['invInit','cfAn','dureeTRI','valRevente','incTNS'].forEach(id=>{
  document.addEventListener('input',e=>{ if(e.target.id===id) calcTRI(); });
});

// ---------- Export PDF & Impression ----------
async function exportPDF(cardId, filename){
  const node = document.getElementById(cardId);
  node.style.background = '#ffffff';
  const canvas = await html2canvas(node, {scale:2, background:'#ffffff', useCORS:true, scrollY:-window.scrollY});
  const imgData = canvas.toDataURL('image/jpeg', 0.95);
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'p', unit:'pt', format:'a4'});
  const pageW = doc.internal.pageSize.getWidth(), pageH = doc.internal.pageSize.getHeight();
  const margin = 36, availW = pageW - margin*2, availH = pageH - margin*2;
  const imgW = canvas.width, imgH = canvas.height;
  const ratio = Math.min(availW/imgW, availH/imgH);
  const drawW = imgW*ratio, drawH = imgH*ratio;
  const x = margin + (availW - drawW)/2, y = margin + (availH - drawH)/2;

  try{ const titre = node.querySelector('h2')?.innerText || 'Calcul'; doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.text(`${titre} ‚Äî ${new Date().toLocaleString('fr-FR')}`, margin, 24); }catch(_){}
  doc.addImage(imgData, 'JPEG', x, y, drawW, drawH);
  const name = filename || 'calcul.pdf';
  try{ doc.save(name); }
  catch(e){ const blob = doc.output('blob'); const url = URL.createObjectURL(blob); try{ window.open(url, '_blank'); } catch(e2){ location.href = url; } setTimeout(()=>URL.revokeObjectURL(url), 60000); }
}
function printCard(cardId){
  const node = document.getElementById(cardId);
  node.classList.add('to-print');
  window.print();
  const cleanup = ()=> node.classList.remove('to-print');
  if ('onafterprint' in window) window.onafterprint = cleanup; else setTimeout(cleanup, 1000);
}

// ---------- Init ----------
function initAll(){ calcVL(); calcDAB(); calcPrix(); calcCF(); calcTRI(); show('home'); }
document.addEventListener('DOMContentLoaded', initAll);
</script>
</body>
</html>



